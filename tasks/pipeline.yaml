---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: spark-images-build
  namespace: tekton-pipelines
spec:
  description: Build all Spark/Zeppelin images using docker buildx bake
  params:
    - name: git-url
      type: string
      default: "https://github.com/electinfo/spark-on-kubernetes.git"
    - name: git-revision
      type: string
      default: "main"
    - name: registry
      type: string
      default: "registry.container-registry.svc.cluster.local:5000"
    - name: tag
      type: string
      default: "latest"
    - name: targets
      type: string
      default: "default"
      description: "Build targets: default, spark-images, zeppelin-images, or specific target"
  workspaces:
    - name: shared-workspace
  tasks:
    - name: fetch-source
      taskRef:
        name: electinfo-git-clone
      params:
        - name: repo-url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: build-images
      runAfter:
        - fetch-source
      taskRef:
        name: docker-buildx-bake
      params:
        - name: registry
          value: $(params.registry)
        - name: tag
          value: $(params.tag)
        - name: targets
          value: $(params.targets)
      workspaces:
        - name: source
          workspace: shared-workspace
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: docker-buildx-bake
  namespace: tekton-pipelines
spec:
  description: Build Docker images using docker buildx bake with DinD sidecar
  params:
    - name: registry
      type: string
      default: "registry.container-registry.svc.cluster.local:5000"
    - name: tag
      type: string
      default: "latest"
    - name: targets
      type: string
      default: "default"
    - name: dind-image
      type: string
      default: "docker:27-dind"
  workspaces:
    - name: source
  sidecars:
    - name: docker
      image: $(params.dind-image)
      args:
        - "--tls=false"
        - "--insecure-registry=registry.container-registry.svc.cluster.local:5000"
      securityContext:
        privileged: true
      env:
        - name: DOCKER_TLS_CERTDIR
          value: ""
      volumeMounts:
        - name: docker-socket
          mountPath: /var/run
        - name: dind-storage
          mountPath: /var/lib/docker
      readinessProbe:
        periodSeconds: 1
        exec:
          command: ["docker", "info"]
  steps:
    - name: bake
      image: docker:27-cli
      workingDir: $(workspaces.source.path)
      env:
        - name: DOCKER_HOST
          value: unix:///var/run/docker.sock
        - name: DOCKER_BUILDKIT
          value: "1"
      script: |
        #!/bin/sh
        set -ex

        # Wait for docker daemon (needed for buildx CLI)
        echo "Waiting for Docker daemon..."
        until docker info; do
          sleep 1
        done

        # Export variables for docker-bake.hcl
        export REGISTRY="$(params.registry)"
        export TAG="$(params.tag)"

        # Create buildkitd config for insecure registry
        mkdir -p /tmp/buildkit
        cat > /tmp/buildkit/buildkitd.toml <<-'EOF'
        [registry."registry.container-registry.svc.cluster.local:5000"]
          http = true
          insecure = true
        EOF

        # Remove any existing builder to ensure fresh config
        docker buildx rm k8s-builder 2>/dev/null || true

        # Create a kubernetes driver builder - this supports cross-target refs
        # and runs BuildKit pods in the cluster
        docker buildx create \
          --name k8s-builder \
          --driver kubernetes \
          --driver-opt namespace=tekton-pipelines \
          --driver-opt replicas=1 \
          --config /tmp/buildkit/buildkitd.toml \
          --use

        docker buildx inspect --bootstrap

        # Build targets - spark-base must be built first and pushed
        # before dependent images can be built
        TARGETS="$(params.targets)"

        if [ "$TARGETS" = "default" ]; then
          echo "=== Building spark-base first ==="
          docker buildx bake --file docker-bake.hcl --push spark-base

          echo "=== Building spark-images (executor, driver, connect-server) ==="
          docker buildx bake --file docker-bake.hcl --push spark-images

          echo "=== Building zeppelin-images (server, interpreter) ==="
          docker buildx bake --file docker-bake.hcl --push zeppelin-images
        else
          docker buildx bake --file docker-bake.hcl --push $TARGETS
        fi

        echo "Build complete!"
      volumeMounts:
        - name: docker-socket
          mountPath: /var/run
  volumes:
    - name: docker-socket
      emptyDir: {}
    - name: dind-storage
      emptyDir: {}