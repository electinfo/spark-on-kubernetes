---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: spark-images-build
  namespace: tekton-pipelines
spec:
  description: Build all Spark/Zeppelin images using docker buildx bake
  params:
    - name: git-url
      type: string
      default: "https://github.com/electinfo/spark-on-kubernetes.git"
    - name: git-revision
      type: string
      default: "main"
    - name: registry
      type: string
      default: "localhost:32000"
    - name: tag
      type: string
      default: "latest"
    - name: targets
      type: string
      default: "default"
      description: "Build targets: default, spark-images, zeppelin-images, or specific target"
  workspaces:
    - name: shared-workspace
  tasks:
    - name: fetch-source
      taskRef:
        name: electinfo-git-clone
      params:
        - name: repo-url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: build-images
      runAfter:
        - fetch-source
      taskRef:
        name: docker-buildx-bake
      params:
        - name: registry
          value: $(params.registry)
        - name: tag
          value: $(params.tag)
        - name: targets
          value: $(params.targets)
      workspaces:
        - name: source
          workspace: shared-workspace
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: docker-buildx-bake
  namespace: tekton-pipelines
spec:
  description: Build Docker images using docker buildx bake with DinD sidecar
  params:
    - name: registry
      type: string
      default: "localhost:32000"
    - name: tag
      type: string
      default: "latest"
    - name: targets
      type: string
      default: "default"
    - name: dind-image
      type: string
      default: "docker:27-dind"
  workspaces:
    - name: source
  sidecars:
    - name: docker
      image: $(params.dind-image)
      securityContext:
        privileged: true
      env:
        - name: DOCKER_TLS_CERTDIR
          value: /certs
      volumeMounts:
        - name: dind-certs
          mountPath: /certs/client
        - name: dind-storage
          mountPath: /var/lib/docker
      readinessProbe:
        periodSeconds: 1
        exec:
          command: ["ls", "/certs/client/ca.pem"]
  steps:
    - name: bake
      image: docker:27-cli
      workingDir: $(workspaces.source.path)
      env:
        - name: DOCKER_HOST
          value: tcp://localhost:2376
        - name: DOCKER_TLS_VERIFY
          value: "1"
        - name: DOCKER_CERT_PATH
          value: /certs/client
        - name: DOCKER_BUILDKIT
          value: "1"
      script: |
        #!/bin/sh
        set -ex

        # Wait for docker daemon
        echo "Waiting for Docker daemon..."
        until docker info; do
          sleep 1
        done

        # Create and use buildx builder
        docker buildx create --name builder --driver docker-container --use
        docker buildx inspect --bootstrap

        # Run docker buildx bake with parameters
        docker buildx bake \
          --file docker-bake.hcl \
          --set "*.args.REGISTRY=$(params.registry)" \
          --set "REGISTRY=$(params.registry)" \
          --set "TAG=$(params.tag)" \
          --push \
          $(params.targets)

        echo "Build complete!"
      volumeMounts:
        - name: dind-certs
          mountPath: /certs/client
          readOnly: true
  volumes:
    - name: dind-certs
      emptyDir: {}
    - name: dind-storage
      emptyDir: {}