---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: spark-images-build
  namespace: tekton-pipelines
spec:
  description: Build all Spark/Zeppelin images using docker buildx bake
  params:
    - name: git-url
      type: string
      default: "https://github.com/electinfo/spark-on-kubernetes.git"
    - name: git-revision
      type: string
      default: "main"
    - name: registry
      type: string
      default: "localhost:32000"
    - name: tag
      type: string
      default: "latest"
    - name: targets
      type: string
      default: "default"
      description: "Build targets: default, spark-images, zeppelin-images, or specific target"
  workspaces:
    - name: shared-workspace
  tasks:
    - name: fetch-source
      taskRef:
        name: git-clone
        kind: ClusterTask
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
        - name: deleteExisting
          value: "true"
      workspaces:
        - name: output
          workspace: shared-workspace

    - name: build-images
      runAfter:
        - fetch-source
      taskRef:
        name: docker-buildx-bake
      params:
        - name: registry
          value: $(params.registry)
        - name: tag
          value: $(params.tag)
        - name: targets
          value: $(params.targets)
      workspaces:
        - name: source
          workspace: shared-workspace
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: docker-buildx-bake
  namespace: tekton-pipelines
spec:
  description: Build Docker images using docker buildx bake
  params:
    - name: registry
      type: string
      default: "localhost:32000"
    - name: tag
      type: string
      default: "latest"
    - name: targets
      type: string
      default: "default"
  workspaces:
    - name: source
  steps:
    - name: bake
      image: docker:24-dind
      securityContext:
        privileged: true
      script: |
        #!/bin/sh
        set -ex

        # Start Docker daemon
        dockerd &
        sleep 5

        # Wait for Docker to be ready
        until docker info; do
          echo "Waiting for Docker..."
          sleep 2
        done

        # Create buildx builder
        docker buildx create --name builder --use
        docker buildx inspect --bootstrap

        cd $(workspaces.source.path)

        # Run docker buildx bake with parameters
        docker buildx bake \
          --set "*.platform=linux/amd64" \
          --set "REGISTRY=$(params.registry)" \
          --set "TAG=$(params.tag)" \
          --push \
          $(params.targets)
      volumeMounts:
        - name: docker-socket
          mountPath: /var/run/docker.sock
  volumes:
    - name: docker-socket
      emptyDir: {}