---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: spark-images-build
  namespace: tekton-pipelines
spec:
  description: Build all Spark/Zeppelin images using docker buildx bake
  params:
    - name: git-url
      type: string
      default: "https://github.com/electinfo/spark-on-kubernetes.git"
    - name: git-revision
      type: string
      default: "main"
    - name: registry
      type: string
      default: "registry.container-registry.svc.cluster.local:5000"
    - name: tag
      type: string
      default: "latest"
    - name: targets
      type: string
      default: "default"
      description: "Build targets: default, spark-images, zeppelin-images, or specific target"
  workspaces:
    - name: shared-workspace
  tasks:
    - name: fetch-source
      taskRef:
        name: electinfo-git-clone
      params:
        - name: repo-url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: build-images
      runAfter:
        - fetch-source
      taskRef:
        name: docker-buildx-bake
      params:
        - name: registry
          value: $(params.registry)
        - name: tag
          value: $(params.tag)
        - name: targets
          value: $(params.targets)
      workspaces:
        - name: source
          workspace: shared-workspace
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: docker-buildx-bake
  namespace: tekton-pipelines
spec:
  description: Build Docker images using docker buildx bake with DinD sidecar
  params:
    - name: registry
      type: string
      default: "registry.container-registry.svc.cluster.local:5000"
    - name: tag
      type: string
      default: "latest"
    - name: targets
      type: string
      default: "default"
    - name: dind-image
      type: string
      default: "docker:27-dind"
  workspaces:
    - name: source
  sidecars:
    - name: docker
      image: $(params.dind-image)
      args:
        - "--tls=false"
        - "--insecure-registry=registry.container-registry.svc.cluster.local:5000"
      securityContext:
        privileged: true
      env:
        - name: DOCKER_TLS_CERTDIR
          value: ""
      volumeMounts:
        - name: docker-socket
          mountPath: /var/run
        - name: dind-storage
          mountPath: /var/lib/docker
      readinessProbe:
        periodSeconds: 1
        exec:
          command: ["docker", "info"]
  steps:
    - name: bake
      image: docker:27-cli
      workingDir: $(workspaces.source.path)
      env:
        - name: DOCKER_HOST
          value: unix:///var/run/docker.sock
        - name: DOCKER_BUILDKIT
          value: "1"
      script: |
        #!/bin/sh
        set -ex

        # Wait for docker daemon
        echo "Waiting for Docker daemon..."
        until docker info; do
          sleep 1
        done

        # Use default builder (no docker-container driver needed)
        docker buildx use default

        # Export variables for docker-bake.hcl
        export REGISTRY="$(params.registry)"
        export TAG="$(params.tag)"

        # Note: insecure-registries must be configured on the DinD sidecar, not the client

        # Run docker buildx bake with parameters
        docker buildx bake \
          --file docker-bake.hcl \
          --push \
          $(params.targets)

        echo "Build complete!"
      volumeMounts:
        - name: docker-socket
          mountPath: /var/run
  volumes:
    - name: docker-socket
      emptyDir: {}
    - name: dind-storage
      emptyDir: {}