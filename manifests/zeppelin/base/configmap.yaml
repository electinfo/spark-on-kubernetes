apiVersion: v1
kind: ConfigMap
metadata:
  name: zeppelin-server-conf-map
  namespace: zeppelin
data:
  # Service domain for accessing Zeppelin UI and Spark UI
  # Wildcard subdomain *.zeppelin.elect.info should point to the same address
  SERVICE_DOMAIN: zeppelin.elect.info

  # Spark container image for executors
  ZEPPELIN_K8S_SPARK_CONTAINER_IMAGE: localhost:32000/electinfo/spark-executor:latest

  # Zeppelin interpreter image (Spark driver pods)
  ZEPPELIN_K8S_CONTAINER_IMAGE: localhost:32000/electinfo/zeppelin-interpreter:latest

  # Zeppelin installation path
  ZEPPELIN_HOME: /opt/zeppelin

  # RPC port range for interpreter communication
  ZEPPELIN_SERVER_RPC_PORTRANGE: "12320:12320"

  # Spark master - empty for Spark Connect mode (uses spark.remote instead)
  SPARK_MASTER: ""

  # Spark home in the container
  SPARK_HOME: /opt/spark

  # Namespace for interpreter pods
  ZEPPELIN_K8S_NAMESPACE: zeppelin

  # Service account for interpreter pods (needs RBAC to create executor pods)
  ZEPPELIN_K8S_SERVICE_ACCOUNT: zeppelin-server

  # Git notebook storage configuration
  ZEPPELIN_NOTEBOOK_STORAGE: org.apache.zeppelin.notebook.repo.GitNotebookRepo
  ZEPPELIN_NOTEBOOK_DIR: /opt/zeppelin/notebook

  # Disable Spark version check (Spark 4.1.0 not yet in supported list)
  ZEPPELIN_SPARK_ENABLESUPPORTEDVERSIONCHECK: "false"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: zeppelin-server-conf
  namespace: zeppelin
data:
  nginx.conf: |
    daemon off;
    worker_processes auto;
    events {
      worker_connections 1024;
    }
    http {
      map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
      }

      # Proxy to Zeppelin server
      server {
        listen 80;

        # WebSocket endpoint
        location /ws {
          proxy_pass http://localhost:8080;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;

          # WebSocket timeout settings - keep connection alive
          proxy_read_timeout 3600s;
          proxy_send_timeout 3600s;
          proxy_connect_timeout 60s;

          # Disable buffering for real-time data
          proxy_buffering off;
          proxy_cache off;
        }

        # All other requests
        location / {
          proxy_pass http://localhost:8080;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;

          # Longer timeouts for notebook operations
          proxy_read_timeout 300s;
          proxy_send_timeout 300s;
          proxy_connect_timeout 60s;

          proxy_redirect http://localhost $scheme://SERVICE_DOMAIN;
        }
      }
    }
